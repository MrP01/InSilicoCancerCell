\documentclass[25pt, a0paper, portrait]{tikzposter}
\usepackage[beamer]{prettytex/base}
\usepackage{prettytex/math}
\usepackage{prettytex/code}
% \usepackage[backend=biber,style=numeric]{biblatex}
\input{../macros.tex}
\newcommand{\midrule}{\hline}

\addbibresource{../../literature/sources.bib}

\title{Real-time interaction with an electrophysiological cancer cell model}
\author{
  Peter Waldert,
  Theresa Rienm√ºller,
  Christian Baumgartner,
  Sonja Langthaler
}
\date{\today}
\institute{
  Institute of Health Care Engineering
  with European Testing Center of Medical Devices
}

\definecolor{TUGraz}{HTML}{f70146}
% \definecolor{TUGraz}{HTML}{e4154b}
\definecolor{Accent}{RGB}{136, 58, 234}

\definecolorstyle{TUGrazColorStyle}{
  \colorlet{colorTwo}{TUGraz}
}{
  % Background Colors
  \colorlet{backgroundcolor}{white}
  \colorlet{framecolor}{TUGraz}
  % Title Colors
  \colorlet{titlefgcolor}{black}
  \colorlet{titlebgcolor}{TUGraz}
  % Block Colors
  \colorlet{blocktitlebgcolor}{Accent}
  \colorlet{blocktitlefgcolor}{black}
  \colorlet{blockbodybgcolor}{colorTwo}
  \colorlet{blockbodyfgcolor}{black}
  % Innerblock Colors
  \colorlet{innerblocktitlebgcolor}{white}
  \colorlet{innerblocktitlefgcolor}{black}
  \colorlet{innerblockbodybgcolor}{white}
  \colorlet{innerblockbodyfgcolor}{black}
  % Note colors
  \colorlet{notefgcolor}{black}
  \colorlet{notebgcolor}{white}
  \colorlet{notefrcolor}{white}
}

\usetheme{Simple}
\usecolorstyle{TUGrazColorStyle}
\usetitlestyle{Empty}
\useblockstyle{Minimal}

\settitle{
  \color{titlefgcolor} {\bfseries \Huge \sc \@title \par}
  \vspace*{1em}
  {\huge \@author \par} \vspace*{1em} {\LARGE \@institute}  
  % \vbox{
  %   % \@titlegraphic \\[\TP@titlegraphictotitledistance]
  % }
}

\begin{document}
  \maketitle[width=\linewidth]

  \node[anchor=east] at ([xshift=-1cm, yshift=-1cm]TP@title.east) {\includegraphics[width=10cm]{../logos/tugraz.pdf}};
  \node[anchor=east] at ([xshift=-10cm, yshift=-1cm]TP@title.east) {\includegraphics[width=15cm]{../logos/biotechmed-graz.eps}};
  % \node[] at (33.1in/2-10cm, -46.8in/2+4cm) {\includegraphics[width=15cm]{../logos/biotechmed-graz.eps}};

  \begin{columns}
    \column{0.8}
    \block{Live, In-Browser Cell Simulation Interface}{
      \includegraphics[width=\linewidth]{../../figures/above-the-fold-screenshot.png}
      Available live on \href{https://in-silico.hce.tugraz.at/}{in-silico.hce.tugraz.at}.
    }

    \column{0.2}
    \block{Good stuff}{}
  \end{columns}

  \begin{columns}
    \column{0.5}
    \block{Model}{
      % The whole cell current $I: T \to \R$ over time $t \in T \subset \R^+$ is then obtained as the sum of all individual channel contributions $I_k, k \in \{1, ..., M\}$ over $M \in \N$ channel types
      \begin{equation}
        I(t) := \sum_{k=1}^{M} N_k I_k(t) = \sum_{k=1}^{M} N_k g_k p_{o,k} \left(V(t)-E_k\right)\,,
        \label{eq:current}
      \end{equation}
      % where $N_k$ is the number of channels of type $k \in \{1, ..., M\}$, $g_k$ is the respective ion channel's conductivity, $p_{o, k} \in [0, 1]$ is the probability of observing the channel in a state where an ion current can flow (``open states''), $V: T \to \R$ is the voltage across the membrane and $E_k \in \R$ the reversal potential.

      At each time step,
      \begin{equation}
        \vec{s}_{k,n+1} = H_{k}\left(V(t_n), \vec{C}(t_n), t_n\right) \vec{s}_{k,n}
      \end{equation}
      % where $\vec{s}_{k,n} \in [0, 1]^{N_{s,k}}$ is the state vector of ion channel type $k$ at the $n$-th time step, $H_{k}\left(V, \vec{C}, t_n\right) \in [0, 1]^{N_{s,k} \times N_{s,k}}$ the transition matrix for type $k$ with $\sum_{j=1}^{N_{s,k}} \{H_k\}_{i,j} = 1 \;\forall\,i$, $V(t_n)$ the voltage across the membrane at time $t_n$ and $\vec{C}(t_n) \in \R^4$ the concentrations of Kalium, Calcium, Sodium and Chlorine at time $t_n$.
    }
    \block{Formulation as a Quadratic Program}{
      Relaxing the integer condition on the solution, and letting $\vec{d} := \vec{I}_{\rm meas}$ for brevity, we can reformulate \Cref{eq:minimization},
      $$\vec{N}_{\rm opt} \approx \argmin_{\vec{x} \in \R_+^M} f(\vec{x}) = \argmin_{\vec{x} \in \R_+^M} \sfrac{1}{2} \norm{R \vec{x} - \vec{d}}^2\,,$$
      with cost function $f: \R^M \to \R^+$, which we manipulate to
      \begin{align*}
        f(\vec{x}) & = \sfrac{1}{2} (R \vec{x} - \vec{d})^T (R \vec{x} - \vec{d})                                                          \\
                   & = \sfrac{1}{2} \left(\vec{x}^T R^T R \vec{x} - \vec{x}^T R^T \vec{d} - \vec{d}^T R \vec{x} + \vec{d}^T \vec{d}\right) \\
                   & = \sfrac{1}{2} \left(\vec{x}^T P \vec{x} + \vec{x}^T \vec{q} + \vec{q}^T \vec{x}\right) + \mathcal{O}(1)              \\
                   & = \sfrac{1}{2} \vec{x}^T P \vec{x} + \vec{q}^T \vec{x} + \mathcal{O}(1)
      \end{align*}
      where we let $P := R^T R \in \R^{M \times M}$ and $\vec{q} := -R^T \vec{d} \in \R^M$ and leave out the constant $\vec{d}^T \vec{d}$ as $\mathcal{O}(1)$.
      We can express the nonnegativity constraint $\vec{x} \ge \vec{0}$ as an equality constraint using a slack variable $\vec{s} \in \R_+^M$,
      $$-\vec{x} + \vec{s} = \vec{0} \quad\Leftrightarrow\quad A \vec{x} + \vec{s} = \vec{b}\,,$$
      where we set $A := -\mathds{1} \in \R^{M \times M}$ and $\vec{b} := \vec{0} \in \R^M$.
      This leaves us with a constrained \textit{quadratic program},
      \begin{align}
        \min_{\vec{x} \in \R^M} & \frac{1}{2} \vec{x}^T P \vec{x} + \vec{q}^T \vec{x},     \\
        s.t.\;                  & A \vec{x} + \vec{s} = \vec{b}\,,\; \vec{s} \in \R_+^M\,.
      \end{align}

      We solve the quadratic problem in this exact form using Clarabel \cite{2024-clarabel}.
      Note that in Clarabel notation, the slack variable is to be taken as an element of the nonnegativity cone.

      The integer solution can then be obtained from rounding,
      $$\vec{N}_{\rm opt} = \lfloor \vec{x} \rceil \in \N_0^M\,.$$
    }
    \block{Pointwise Error between Simulation and Measurements}{
      \includegraphics[width=\linewidth]{../../figures/results/simulation-error.pdf}
      % \caption{Pointwise error between the measured current $\vec{I}_{\rm meas}$ and the simulated current $\vec{I}$, showing potential systematic problems within the computational model's representation of the ion channels as compared to the experimental results.}
    }

    \column{0.5}
    \block{Adaptive Timestepping}{
      \begin{equation}
        (\Delta t)_{n+1} = (\Delta t)_{n} \left(\frac{\Delta^{\rm tol}}{\sum_{k=1}^{M} N_k \norm{\vec{s}_{k,n+1} - \vec{s}_{k,n}}}\right)^{1/2}\,,
        \label{eq:dt-heuristic}
      \end{equation}

      % \begin{figure}
      \includegraphics[width=\linewidth]{../../figures/results/delta-tolerance.pdf}
      % \caption{Relative change of the average timestep $\Delta t$ (in blue), simulation runtime (in violet) and step acceptance rate (in green) when varying the delta tolerance $\Delta^{\rm tol}$ on a log-scale. All three quantities were normalized from their individual extent to $[0, 1]$. The most effective $\Delta^{\rm tol}$ is arguably on the order of $10^{-4}$.}
      % \label{figure:delta-tolerance}
      % \end{figure}
    }
    \block{Comparison of Optimization Methods}{
      % \begin{table*}[ht]
      % \centering
      % \caption{Comparison of Optimization Approaches, evaluated on the G0 cell cycle phase with the activation voltage protocol. Runtime estimates were obtained on an Intel\texttrademark i7-5600U CPU.}
      \begin{tabular}{llrr}
        \textbf{Algorithm}                          & \textbf{Abbreviation} & \textbf{Runtime} / ms & \textbf{RMSE} / pA \\
        % \midrule
        Particle Swarm Optimization                 & PSO                   & 22571                 & 27.69              \\
        Gradient Descent + More Thuente             & GD                    & 18924                 & 32.34              \\
        Limited-Memory BFGS + Hager Zhang           & LBFGS                 & 4845                  & 32.20              \\
        Non-Negative Least Squares \cite{1997-nnls} & NNLS                  & 318                   & 28.00              \\
        Quadratic Program                           & QP                    & 18                    & 28.13              \\
      \end{tabular}
      % \label{table:optimization-comparison}
      % \end{table*}
    }
  \end{columns}

  \block{References}{\printbibliography[heading=none]}
\end{document}
