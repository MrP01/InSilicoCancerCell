---
import * as Plot from "@observablehq/plot";
import { JSDOM } from "jsdom";
import { generatePlot } from "../plots";

const { plot, args, extra } = Astro.props;
const jsdom = new JSDOM();
const staticPlot = Plot.plot({
  ...generatePlot(plot, args),
  ...extra,
  document: jsdom.window._document,
});
---

<astro-figure data-plot={plot} data-args={JSON.stringify(args)} data-extra={JSON.stringify(extra)}>
  <Fragment set:html={staticPlot.outerHTML} />
</astro-figure>

<script>
  import * as Plot from "@observablehq/plot";
  import { generatePlot } from "../plots";

  class AstroFigure extends HTMLElement {
    constructor() {
      super();
      this.innerHTML = "";
      this.appendChild(
        Plot.plot({
          ...generatePlot(this.dataset.plot, JSON.parse(this.dataset.args || "[]"), true),
          ...JSON.parse(this.dataset.extra || ""),
          style: "--plot-background: black",
        })
      );
      console.log(`In-place replacement of ${this.dataset.plot} succeeded.`);
    }
  }
  customElements.define("astro-figure", AstroFigure);
</script>
